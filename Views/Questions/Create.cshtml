@model QuizApp.Models.Question
@using System.Text.Json
@using System.Linq

@{
    ViewData["Title"] = "Create Question";

    // start with at least 2 empty options
    var optionsList = Model.Options?.ToList() ?? new List<QuizApp.Models.Option>();

    if (!optionsList.Any())
    {
        optionsList.Add(new QuizApp.Models.Option { Text = "", IsCorrect = false });
        optionsList.Add(new QuizApp.Models.Option { Text = "", IsCorrect = false });
    }

    var initialState = new {
        quizId = Model.QuizId,
        text = Model.Text ?? "",
        points = Model.Points,
        options = optionsList.Select(o => new {
            text = o.Text ?? "",
            isCorrect = o.IsCorrect
        }),
        correctIndex = optionsList.FindIndex(o => o.IsCorrect)
    };

    var initialJson = JsonSerializer.Serialize(initialState);
}

<h2>Create Question â€” @ViewBag.Quiz.Title</h2>

<div id="question-create-app">

    <form asp-action="Create" method="post" novalidate>
        <input type="hidden" asp-for="QuizId" />

        <!-- TEXT -->
        <div class="mb-3">
            <label asp-for="Text" class="form-label"></label>
            <input asp-for="Text" class="form-control" v-model="text" />
            <span asp-validation-for="Text" class="text-danger"></span>
        </div>

        <!-- POINTS -->
        <div class="mb-3">
            <label asp-for="Points" class="form-label"></label>
            <input asp-for="Points" type="number" class="form-control" v-model.number="points" />
            <span asp-validation-for="Points" class="text-danger"></span>
        </div>

        <hr />
        <h4>Answer Options</h4>

        <!-- OPTIONS -->
        <div class="option-row mb-2"
             v-for="(opt, idx) in options"
             :key="idx">

            <div class="d-flex align-items-center">

                <!-- bind name for POST -->
                <input class="form-control me-2"
                       :name="'Options[' + idx + '].Text'"
                       v-model="opt.text"
                       placeholder="Option text" />

                <!-- correct option -->
                <input type="radio"
                       name="CorrectIndex"
                       :value="idx"
                       v-model.number="correctIndex" />

                <!-- REMOVE -->
                <button type="button"
                        class="btn btn-danger btn-sm ms-2"
                        @@click="removeOption(idx)">
                    X
                </button>
            </div>
        </div>

        <!-- ADD OPTION -->
        <button type="button"
                class="btn btn-secondary mt-2"
                @@click="addOption">
            Add Option
        </button>

        <br /><br />

        <!-- SUBMIT -->
        <button type="submit" class="btn btn-primary">Save</button>

        <a asp-controller="Quiz"
           asp-action="Details"
           asp-route-id="@Model.QuizId"
           class="btn btn-outline-secondary">
            Cancel
        </a>
    </form>
</div>

@section Scripts {

    <script>
        const initial = @Html.Raw(initialJson);
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    quizId: initial.quizId,
                    text: initial.text,
                    points: initial.points,
                    options: initial.options.map(o => ({
                        text: o.text,
                        isCorrect: o.isCorrect
                    })),
                    correctIndex: initial.correctIndex ?? -1
                };
            },

            methods: {
                addOption() {
                    this.options.push({ text: "", isCorrect: false });
                },

                removeOption(index) {
                    this.options.splice(index, 1);

                    if (this.correctIndex === index) {
                        this.correctIndex = -1;
                    } else if (this.correctIndex > index) {
                        this.correctIndex--;
                    }
                }
            }
        }).mount("#question-create-app");

        window.addEventListener("error", event => {
            console.error("Client error on Create Question page:", event.error || event.message);
        });
    </script>
}
