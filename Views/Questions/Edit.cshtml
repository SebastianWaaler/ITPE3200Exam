@model QuizApp.Models.Question
@using System.Text.Json
@using System.Linq

@{
    ViewData["Title"] = "Edit Question";

    var optionsList = Model.Options?.ToList() ?? new List<QuizApp.Models.Option>();

    var initialState = new {
        id = Model.Id,
        quizId = Model.QuizId,
        text = Model.Text ?? "",
        points = Model.Points,
        options = optionsList.Select(o => new {
            id = o.Id,
            text = o.Text ?? "",
            isCorrect = o.IsCorrect
        }),
        correctIndex = optionsList.FindIndex(o => o.IsCorrect)
    };

    var initialJson = JsonSerializer.Serialize(initialState);
}

<h2>Edit Question â€” @(Model.Quiz?.Title ?? "Quiz")</h2>

<div id="question-edit-app">

    <form asp-action="Edit" method="post" novalidate>
        @Html.AntiForgeryToken()

        <!-- MVC hidden inputs -->
        <input asp-for="Id" type="hidden" />
        <input asp-for="QuizId" type="hidden" />

        <!-- Text -->
        <div class="mb-3">
            <label asp-for="Text" class="form-label"></label>
            <input asp-for="Text" class="form-control" v-model="text" />
            <span asp-validation-for="Text" class="text-danger"></span>
        </div>

        <!-- Points -->
        <div class="mb-3">
            <label asp-for="Points" class="form-label"></label>
            <input asp-for="Points" type="number" class="form-control" v-model.number="points" />
            <span asp-validation-for="Points" class="text-danger"></span>
        </div>

        <hr />
        <h4>Answer Options</h4>

        <!-- Vue-controlled options -->
        <div class="option-row mb-2" 
             v-for="(opt, idx) in options" 
             :key="idx">

            <div class="d-flex align-items-center">

                <!-- Hidden Option ID -->
                <input type="hidden"
                       :name="'Options[' + idx + '].Id'"
                       :value="opt.id" />

                <!-- Option Text -->
                <input class="form-control me-2"
                       :name="'Options[' + idx + '].Text'"
                       v-model="opt.text" />

                <!-- Hidden IsCorrect sync -->
                <input type="hidden"
                       :name="'Options[' + idx + '].IsCorrect'"
                       :value="opt.isCorrect" />

                <!-- Correct answer selector -->
                <input type="radio"
                       name="CorrectIndex"
                       :value="idx"
                       v-model.number="correctIndex" />

                <!-- Remove Option -->
                <button type="button"
                        class="btn btn-danger btn-sm ms-2"
                        @@click="removeOption(idx)">
                    X
                </button>
            </div>
        </div>

        <!-- Add option -->
        <button type="button"
                class="btn btn-secondary mt-2"
                @@click="addOption">
            Add Option
        </button>

        <br /><br />

        <button type="submit" class="btn btn-primary">Save</button>

        <a asp-controller="Quiz"
           asp-action="Details"
           asp-route-id="@Model.QuizId"
           class="btn btn-outline-secondary">
            Cancel
        </a>

    </form>
</div>

@section Scripts {
    

    <script>
        const { createApp, watch } = Vue;

        const initial = @Html.Raw(initialJson);

        createApp({
            data() {
                return {
                    id: initial.id,
                    quizId: initial.quizId,
                    text: initial.text,
                    points: initial.points,
                    options: initial.options.map(o => ({
                        id: o.id,
                        text: o.text,
                        isCorrect: o.isCorrect
                    })),
                    correctIndex: initial.correctIndex ?? -1
                };
            },

            watch: {
                correctIndex(newVal) {
                    this.options.forEach((o, i) => {
                        o.isCorrect = (i === newVal);
                    });
                }
            },

            methods: {
                addOption() {
                    this.options.push({
                        id: 0,
                        text: "",
                        isCorrect: false
                    });
                },

                removeOption(index) {
                    this.options.splice(index, 1);

                    if (this.correctIndex === index) {
                        this.correctIndex = -1;
                    } else if (this.correctIndex > index) {
                        this.correctIndex--;
                    }
                }
            }
        }).mount("#question-edit-app");

        window.addEventListener("error", e => {
            console.error("Client error on Edit Question page:", e.error || e.message);
        });
    </script>
}
