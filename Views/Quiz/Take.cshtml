@model QuizApp.Models.Quiz     

<div id="take-quiz-app">

    <div class="mb-4" v-if="quiz">
        <h1 class="mb-1">{{ quiz.title }}</h1>
        <p class="text-muted">{{ quiz.description }}</p>
    </div>

    <p v-if="loading">Loading quiz...</p>
    <p v-if="error" class="text-danger">{{ error }}</p>

    <form v-if="!loading && quiz && quiz.questions && quiz.questions.length"
          method="post"
          asp-action="Submit"
          class="card shadow-sm p-4">

        <input type="hidden" name="QuizId" :value="quiz.quizId" />

        <div v-for="question in quiz.questions"
             :key="question.id"
             class="mb-4 p-3 border rounded bg-light">

            <strong class="d-block mb-2">{{ question.text }}</strong>

            <div class="form-check mb-1"
                 v-for="option in question.options"
                 :key="option.id">

                <label class="form-check-label">
                    <input type="radio"
                           class="form-check-input"
                           :name="'question_' + question.id"
                           :value="option.id" />

                    {{ option.text }}
                </label>
            </div>
        </div>

        <hr />

        <button type="submit" class="btn btn-primary mt-3">
            Submit Quiz
        </button>
    </form>

    <p v-if="!loading && quiz && (!quiz.questions || quiz.questions.length === 0)">
        This quiz has no questions yet.
    </p>

</div>

@section Scripts {
    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    quizId: @Model.QuizId,
                    quiz: null,
                    loading: true,
                    error: null
                };
            },

            async mounted() {
                try {
                    const response = await fetch(`/api/QuizApi/${this.quizId}`);

                    if (!response.ok) {
                        if (response.status === 401 || response.status === 403) {
                            this.error = "You must be logged in to take this quiz.";
                        } else if (response.status === 404) {
                            this.error = "Quiz not found.";
                        } else {
                            this.error = "Failed to load quiz.";
                        }
                        return;
                    }

                    this.quiz = await response.json();

                } catch (err) {
                    console.error(err);
                    this.error = "Could not load quiz. Please try again.";
                } finally {
                    this.loading = false;
                }
            }
        }).mount('#take-quiz-app');
        window.addEventListener("error", event => {
            console.error("Client error on Take Quiz page:", event.error || event.message);
        });
    </script>
}
