@* 
    Main quiz list page. Displays all available quizzes in a table.
    Features:
    - Search/filter functionality to find quizzes by title or description
    - Admin users see "New Quiz" button and management buttons (Details, Edit, Delete)
    - All users (logged in or not) can see and click "Take Quiz" buttons
    - Uses Vue.js for dynamic content filtering and conditional rendering
*@
@{
    ViewData["Title"] = "Quizzes";

    var isAdmin = User.IsInRole("Admin");
}

<h2 class="mb-3">Quizzes</h2>

<div class="d-flex justify-content-between align-items-center mb-3">

    @* Only admin can create quiz *@
    @if (isAdmin)
    {
        <a class="btn btn-primary" href="/Quiz/Create">New Quiz</a>
    }
</div>

    @* Vue.js root element - manages dynamic quiz list and search functionality *@
<div id="quiz-index-app">

    @* Search input field - filters quizzes in real-time as user types *@
    <div class="mb-3" v-if="!loading">
        <div class="row">
            <div class="col-md-6">
                <input 
                    type="text" 
                    class="form-control" 
                    placeholder="Search quizzes by title or description..." 
                    v-model="searchQuery"
                    @@input="filterQuizzes" />
            </div>
            <div class="col-md-6">
                @* Shows count of filtered results vs total quizzes *@
                <p class="text-muted mb-0" v-if="filteredQuizzes.length !== quizzes.length">
                    Showing {{ filteredQuizzes.length }} of {{ quizzes.length }} quizzes
                </p>
            </div>
        </div>
    </div>

    @* Loading spinner displayed while fetching quiz data from API *@
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading quizzes...</p>
    </div>

    @* Error message displayed if API call fails *@
    <div v-if="error" class="alert alert-danger" role="alert">
        <strong>Error:</strong> {{ error }}
    </div>

    @* Main quiz table - displays filtered quiz results *@
    <table v-if="!loading && filteredQuizzes.length" class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th></th>
            </tr>
        </thead>

        <tbody>
            @* Loop through each quiz in filtered results *@
            <tr v-for="q in filteredQuizzes" :key="q.quizId">

                <td>{{ q.title }}</td>
                <td>{{ q.description }}</td>

                <td class="text-end">
                    @* Admin-only management buttons - only visible to users with Admin role *@
                    <template v-if="isAdmin">
                        @* View quiz details, questions, and options *@
                        <a 
                            class="btn btn-sm btn-primary me-2"
                            :href="'/Quiz/Details/' + q.quizId">
                            Details
                        </a>

                        @* Edit quiz title and description *@
                        <a 
                            class="btn btn-sm btn-warning me-2"
                            :href="'/Quiz/Edit/' + q.quizId">
                            Edit
                        </a>

                        @* Delete quiz (with confirmation) *@
                        <a 
                            class="btn btn-sm btn-danger me-2"
                            :href="'/Quiz/Delete/' + q.quizId">
                            Delete
                        </a>
                    </template>

                    @* Take Quiz button - visible to everyone (logged in or anonymous) *@
                    <a 
                        class="btn btn-sm btn-success"
                        :href="'/Quiz/Take/' + q.quizId">
                        Take Quiz
                    </a>
                </td>

            </tr>
        </tbody>
    </table>

    @* Message when search returns no results but quizzes exist *@
    <div v-if="!loading && !filteredQuizzes.length && quizzes.length > 0" class="alert alert-info">
        No quizzes match your search criteria.
    </div>
    @* Message when no quizzes exist in database *@
    <div v-if="!loading && !quizzes.length" class="alert alert-info">
        No quizzes found. @if (isAdmin) { <a href="/Quiz/Create">Create the first quiz</a> }
    </div>
</div>

@section Scripts {

    <script>
        @* Vue.js application for quiz list page *@
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    quizzes: [],              // All quizzes loaded from API
                    filteredQuizzes: [],     // Quizzes matching search query
                    searchQuery: "",         // User's search input
                    loading: true,           // Loading state while fetching data
                    error: null,             // Error message if API call fails
                    isAdmin: @isAdmin.ToString().ToLower()  // Whether current user is admin
                };
            },

            @* Called when page loads - fetches all quizzes from API *@
            async mounted() {
                try {
                    const response = await fetch('/api/QuizApi');
                    if (!response.ok) throw new Error('Failed to load quizzes');

                    this.quizzes = await response.json();
                    this.filteredQuizzes = this.quizzes;  // Initially show all quizzes

                } catch (err) {
                    console.error(err);
                    this.error = "Failed to load quizzes.";
                } finally {
                    this.loading = false;
                }
            },

            methods: {
                @* Filters quizzes based on search query - matches title or description *@
                filterQuizzes() {
                    const query = this.searchQuery.toLowerCase().trim();
                    
                    // If no search query, show all quizzes
                    if (!query) {
                        this.filteredQuizzes = this.quizzes;
                        return;
                    }

                    // Filter quizzes where title or description contains search query
                    this.filteredQuizzes = this.quizzes.filter(quiz => {
                        const titleMatch = quiz.title?.toLowerCase().includes(query) || false;
                        const descMatch = quiz.description?.toLowerCase().includes(query) || false;
                        return titleMatch || descMatch;
                    });
                }
            }
        }).mount('#quiz-index-app');
        window.addEventListener("error", function (event) {
            console.error("Client error on Quiz Index page:", event.error || event.message);
            alert("Something went wrong on this page. Please try again.");
        });
    </script>

}
