@{
    ViewData["Title"] = "Quizzes";

    // Server only tells Vue if user is admin
    var isAdmin = User.IsInRole("Admin");
}

<h2 class="mb-3">Quizzes</h2>

<div class="d-flex justify-content-between align-items-center mb-3">

    @* Only admin can create quiz *@
    @if (isAdmin)
    {
        <a class="btn btn-primary" href="/Quiz/Create">New Quiz</a>
    }
</div>

<!-- Vue root -->
<div id="quiz-index-app">

    <!-- Loading -->
    <p v-if="loading">Loading quizzes...</p>

    <!-- Error -->
    <p v-if="error" class="text-danger">{{ error }}</p>

    <!-- Quiz table -->
    <table v-if="!loading && quizzes.length" class="table table-striped">
        <thead>
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th></th>
            </tr>
        </thead>

        <tbody>
            <tr v-for="q in quizzes" :key="q.quizId">

                <td>{{ q.title }}</td>
                <td>{{ q.description }}</td>

                <td class="text-end">
                    @* Admin-only buttons *@
                    <template v-if="isAdmin">
                        <a 
                            class="btn btn-sm btn-primary me-2"
                            :href="'/Quiz/Details/' + q.quizId">
                            Details
                        </a>

                        <a 
                            class="btn btn-sm btn-warning me-2"
                            :href="'/Quiz/Edit/' + q.quizId">
                            Edit
                        </a>

                        <a 
                            class="btn btn-sm btn-danger me-2"
                            :href="'/Quiz/Delete/' + q.quizId">
                            Delete
                        </a>
                    </template>

                    @* Everyone logged in or not sees Take *@
                    <a 
                        class="btn btn-sm btn-success"
                        :href="'/Quiz/Take/' + q.quizId">
                        Take Quiz
                    </a>
                </td>

            </tr>
        </tbody>
    </table>

    <p v-if="!loading && !quizzes.length">No quizzes found.</p>
</div>

@section Scripts {

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    quizzes: [],
                    loading: true,
                    error: null,
                    isAdmin: @isAdmin.ToString().ToLower()
                };
            },

            async mounted() {
                try {
                    const response = await fetch('/api/QuizApi');
                    if (!response.ok) throw new Error('Failed to load quizzes');

                    this.quizzes = await response.json();

                } catch (err) {
                    console.error(err);
                    this.error = "Failed to load quizzes.";
                } finally {
                    this.loading = false;
                }
            }
        }).mount('#quiz-index-app');

        // client-side error handler for this page
        window.addEventListener("error", function (event) {
            console.error("Client error on Quiz Index page:", event.error || event.message);
            alert("Something went wrong on this page. Please try again.");
        });
    </script>

}
