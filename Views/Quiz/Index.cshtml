@{
    ViewData["Title"] = "Quizzes";

    // Server only tells Vue if user is admin
    var isAdmin = User.IsInRole("Admin");
}

<h2 class="mb-3">Quizzes</h2>

<div class="d-flex justify-content-between align-items-center mb-3">

    @* Only admin can create quiz *@
    @if (isAdmin)
    {
        <a class="btn btn-primary" href="/Quiz/Create">New Quiz</a>
    }
</div>

<!-- Vue root -->
<div id="quiz-index-app">

    <!-- Search/Filter Section -->
    <div class="mb-3" v-if="!loading">
        <div class="row">
            <div class="col-md-6">
                <input 
                    type="text" 
                    class="form-control" 
                    placeholder="Search quizzes by title or description..." 
                    v-model="searchQuery"
                    @@input="filterQuizzes" />
            </div>
            <div class="col-md-6">
                <p class="text-muted mb-0" v-if="filteredQuizzes.length !== quizzes.length">
                    Showing {{ filteredQuizzes.length }} of {{ quizzes.length }} quizzes
                </p>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div v-if="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading quizzes...</p>
    </div>

    <!-- Error -->
    <div v-if="error" class="alert alert-danger" role="alert">
        <strong>Error:</strong> {{ error }}
    </div>

    <!-- Quiz table -->
    <table v-if="!loading && filteredQuizzes.length" class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th></th>
            </tr>
        </thead>

        <tbody>
            <tr v-for="q in filteredQuizzes" :key="q.quizId">

                <td>{{ q.title }}</td>
                <td>{{ q.description }}</td>

                <td class="text-end">
                    @* Admin-only buttons *@
                    <template v-if="isAdmin">
                        <a 
                            class="btn btn-sm btn-primary me-2"
                            :href="'/Quiz/Details/' + q.quizId">
                            Details
                        </a>

                        <a 
                            class="btn btn-sm btn-warning me-2"
                            :href="'/Quiz/Edit/' + q.quizId">
                            Edit
                        </a>

                        <a 
                            class="btn btn-sm btn-danger me-2"
                            :href="'/Quiz/Delete/' + q.quizId">
                            Delete
                        </a>
                    </template>

                    @* Everyone logged in or not sees Take *@
                    <a 
                        class="btn btn-sm btn-success"
                        :href="'/Quiz/Take/' + q.quizId">
                        Take Quiz
                    </a>
                </td>

            </tr>
        </tbody>
    </table>

    <div v-if="!loading && !filteredQuizzes.length && quizzes.length > 0" class="alert alert-info">
        No quizzes match your search criteria.
    </div>
    <div v-if="!loading && !quizzes.length" class="alert alert-info">
        No quizzes found. @if (isAdmin) { <a href="/Quiz/Create">Create the first quiz</a> }
    </div>
</div>

@section Scripts {

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    quizzes: [],
                    filteredQuizzes: [],
                    searchQuery: "",
                    loading: true,
                    error: null,
                    isAdmin: @isAdmin.ToString().ToLower()
                };
            },

            async mounted() {
                try {
                    const response = await fetch('/api/QuizApi');
                    if (!response.ok) throw new Error('Failed to load quizzes');

                    this.quizzes = await response.json();
                    this.filteredQuizzes = this.quizzes;

                } catch (err) {
                    console.error(err);
                    this.error = "Failed to load quizzes.";
                } finally {
                    this.loading = false;
                }
            },

            methods: {
                // Client-side content filtering: filter quizzes by search query
                filterQuizzes() {
                    const query = this.searchQuery.toLowerCase().trim();
                    
                    if (!query) {
                        this.filteredQuizzes = this.quizzes;
                        return;
                    }

                    // Filter by title or description
                    this.filteredQuizzes = this.quizzes.filter(quiz => {
                        const titleMatch = quiz.title?.toLowerCase().includes(query) || false;
                        const descMatch = quiz.description?.toLowerCase().includes(query) || false;
                        return titleMatch || descMatch;
                    });
                }
            }
        }).mount('#quiz-index-app');

        // client-side error handler for this page
        window.addEventListener("error", function (event) {
            console.error("Client error on Quiz Index page:", event.error || event.message);
            alert("Something went wrong on this page. Please try again.");
        });
    </script>

}
