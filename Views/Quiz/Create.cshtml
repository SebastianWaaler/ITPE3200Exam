@* 
    Admin page for creating a new quiz.
    Allows entering quiz title (required, max 200 chars) and description (optional).
    Uses Vue.js for client-side validation and API calls.
    After creation, redirects to quiz details page where questions can be added.
*@
@model Quiz
@using System.Text.Json

@{
    ViewData["Title"] = "Create Quiz";
    
    @* Prepare initial state for Vue.js from server model (if validation fails and page reloads) *@
    var state = new {
        title = Model?.Title ?? "",
        description = Model?.Description ?? ""
    };

    var json = JsonSerializer.Serialize(state);
}

<h2 class="mb-4">Create Quiz</h2>

@* Vue.js root element for quiz creation form *@
<div id="quiz-create-app">

    @* Display validation errors from client-side validation *@
    <div v-if="errors.length > 0" class="alert alert-danger">
        <ul class="mb-0">
            <li v-for="error in errors" :key="error">{{ error }}</li>
        </ul>
    </div>

    @* Quiz title input - required field, max 200 characters *@
    <div class="mb-3">
        <label for="title">Title <span class="text-danger">*</span></label>
        <input 
            id="title"
            class="form-control" 
            v-model="title" 
            :class="{ 'is-invalid': errors.includes('Title is required') }"
            maxlength="200"
            required />
        <div class="invalid-feedback" v-if="errors.includes('Title is required')">
            Title is required
        </div>
    </div>

    @* Quiz description textarea - optional field *@
    <div class="mb-3">
        <label for="description">Description</label>
        <textarea 
            id="description"
            class="form-control" 
            v-model="description"
            rows="4"></textarea>
    </div>

    @* Save button - disabled while saving, shows spinner during API call *@
    <button class="btn btn-primary" @@click="saveQuiz" :disabled="saving">
        <span v-if="saving" class="spinner-border spinner-border-sm me-2" role="status"></span>
        {{ saving ? 'Saving...' : 'Save' }}
    </button>
    <a class="btn btn-secondary" href="/Quiz">Cancel</a>
</div>

@section Scripts {
<script type="module">

    @* Import quiz service for API calls *@
    import QuizService from "/js/QuizService.js";
    const { createApp } = Vue;

    @* Vue.js application for quiz creation form *@
    createApp({
        data() {
            return {
                title: "",           // Quiz title from input
                description: "",     // Quiz description from textarea
                errors: [],          // Array of validation error messages
                saving: false        // Flag to prevent double-submission
            };
        },
        methods: {
            @* Validates form data before submission *@
            validate() {
                this.errors = [];
                
                @* Title is required and must be 200 characters or less *@
                if (!this.title || this.title.trim() === "") {
                    this.errors.push("Title is required");
                } else if (this.title.length > 200) {
                    this.errors.push("Title must be 200 characters or less");
                }
                
                return this.errors.length === 0;
            },
            
            @* Saves quiz via API and redirects to quiz details page *@
            async saveQuiz() {
                this.errors = [];
                
                @* Don't submit if validation fails *@
                if (!this.validate()) {
                    return;
                }
                
                this.saving = true;
                
                try {
                    @* Prepare quiz data object *@
                    const q = {
                        title: this.title.trim(),
                        description: this.description.trim()
                    };

                    @* Call API to create quiz *@
                    const created = await QuizService.create(q);
                    @* Redirect to quiz details page where questions can be added *@
                    window.location.href = `/Quiz/Details/${created.quizId}`;
                } catch (err) {
                    console.error("Error creating quiz:", err);
                    this.errors.push("Failed to create quiz. Please try again.");
                } finally {
                    this.saving = false;
                }
            }
        }
    }).mount("#quiz-create-app");
    window.addEventListener("error", function (event) {
        console.error("Client error on Create Quiz page:", event.error || event.message);
        alert("Something went wrong on this page. Please try again.");
    });
</script>
}
