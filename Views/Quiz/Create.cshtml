@model Quiz
@using System.Text.Json

@{
    ViewData["Title"] = "Create Quiz";

    // Prepare Vue initial state safely as JSON    
    var state = new {
        title = Model?.Title ?? "",
        description = Model?.Description ?? ""
    };

    var json = JsonSerializer.Serialize(state);
}

<h2 class="mb-4">Create Quiz</h2>

<div id="quiz-create-app">

    <!-- Validation error messages -->
    <div v-if="errors.length > 0" class="alert alert-danger">
        <ul class="mb-0">
            <li v-for="error in errors" :key="error">{{ error }}</li>
        </ul>
    </div>

    <div class="mb-3">
        <label for="title">Title <span class="text-danger">*</span></label>
        <input 
            id="title"
            class="form-control" 
            v-model="title" 
            :class="{ 'is-invalid': errors.includes('Title is required') }"
            maxlength="200"
            required />
        <div class="invalid-feedback" v-if="errors.includes('Title is required')">
            Title is required
        </div>
    </div>

    <div class="mb-3">
        <label for="description">Description</label>
        <textarea 
            id="description"
            class="form-control" 
            v-model="description"
            rows="4"></textarea>
    </div>

    <button class="btn btn-primary" @@click="saveQuiz" :disabled="saving">
        <span v-if="saving" class="spinner-border spinner-border-sm me-2" role="status"></span>
        {{ saving ? 'Saving...' : 'Save' }}
    </button>
    <a class="btn btn-secondary" href="/Quiz">Cancel</a>
</div>

@section Scripts {
<script type="module">

    import QuizService from "/js/QuizService.js";
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                title: "",
                description: "",
                errors: [],
                saving: false
            };
        },
        methods: {
            // Client-side validation before submitting
            validate() {
                this.errors = [];
                
                // Validate title (required, max 200 characters)
                if (!this.title || this.title.trim() === "") {
                    this.errors.push("Title is required");
                } else if (this.title.length > 200) {
                    this.errors.push("Title must be 200 characters or less");
                }
                
                return this.errors.length === 0;
            },
            
            async saveQuiz() {
                // Clear previous errors
                this.errors = [];
                
                // Client-side validation
                if (!this.validate()) {
                    return;
                }
                
                this.saving = true;
                
                try {
                    // Build quiz object for API
                    const q = {
                        title: this.title.trim(),
                        description: this.description.trim()
                    };

                    // Call API to create quiz
                    const created = await QuizService.create(q);

                    // Redirect to quiz details page
                    window.location.href = `/Quiz/Details/${created.quizId}`;
                } catch (err) {
                    console.error("Error creating quiz:", err);
                    this.errors.push("Failed to create quiz. Please try again.");
                } finally {
                    this.saving = false;
                }
            }
        }
    }).mount("#quiz-create-app");

    // Client-side error handler
    window.addEventListener("error", function (event) {
        console.error("Client error on Create Quiz page:", event.error || event.message);
        alert("Something went wrong on this page. Please try again.");
    });
</script>
}
